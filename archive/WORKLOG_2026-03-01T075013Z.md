# WORKLOG

## 2026-02-24T07:33:33Z

- 新建四文件上下文(task_plan/notes/WORKLOG/LATER_PLANS/ERRORFIX),准备修复 `tools/gradio_app.py` 启动时报 `socksio` 缺失的问题.

## 2026-02-24T07:46:46Z

- 通过设置 `ALL_PROXY=socks5://127.0.0.1:1080` 复现并确认根因: `httpx` 在 SOCKS 代理场景需要可选依赖 `socksio`,否则 Gradio import 阶段直接崩溃.
- 在 `pyproject.toml` 增加 `socksio>=1.0.0`,并更新 `pixi.lock` 以保证 Pixi 安装可复现.
- 在 SOCKS 代理环境变量开启的情况下,验证 `import gradio` 与 `runpy.run_path('tools/gradio_app.py', run_name='__test__')` 均不再抛 ImportError.
- 将 `.envrc.private` 加入 `.gitignore`,避免私密配置文件被误提交.

## 2026-02-24T09:00:21Z

- 为 `flux-dev-fill` 增加 ModelScope 镜像下载支持: 本地缺 `ckpt/flux_fill/flux1-fill-dev.safetensors`/`ae.safetensors` 时,优先走 ModelScope `resolve/master/...` 直链下载,失败则回退 HuggingFace.
- 修复旧逻辑在缺文件时的错误路径拼接,并让 AE/Cond-AE 加载路径与下载来源保持一致.
- 更新 `README.md` 的 ModelScope 手动下载命令(支持 curl resume).

## 2026-02-24T11:06:14Z

- 修复 README 的模型下载指引: 将 `FLUX.1-Fill-dev` 的手动下载从 HuggingFace 快照(易触发 xet/CAS 网络错误)调整为优先推荐 ModelScope 直链(支持断点续传),并补充可选的 HuggingFace 快照下载命令: `HF_HUB_DISABLE_XET=1 pixi run hf download ...`.

## 2026-02-24T13:25:00Z

- 修复 Remote-SSH 无 GUI 环境下的 Rerun 报错: 将有副作用的 `simplecv.rerun_log_utils.RerunTyroConfig` 替换为项目自有的纯数据 `VistaRerunConfig`,避免配置构造期默认 `rr.spawn()` 触发 winit 的 DISPLAY/WAYLAND 缺失错误.
- 新增 `src/vistadream/rerun_setup.py` 的统一初始化逻辑 `init_rerun_from_config`,在无 GUI 时自动 `rr.serve_grpc(grpc_port=9876)` 并打印本地 viewer 的连接提示,从根源消除退出时的 gRPC flush 刷屏报错.
- 同步更新 `README.md` 增加 Remote-SSH 场景的 Rerun 连接与 ssh 端口转发说明.

## 2026-02-24T13:55:00Z

- 增加 `--rr-config.wait`/`--rr-config.wait-seconds` 解决 “serve_grpc 启动后 pipeline 跑完立刻退出,本地 viewer 来不及连接” 的体验问题: 仅在启用 gRPC server 时生效,支持等待回车或等待固定秒数.
- 在 `src/vistadream/api/single_img_pipeline.py`/`src/vistadream/api/flux_outpainting.py`/`src/vistadream/api/multi_image_pipeline.py` 的主流程结束处统一调用 `maybe_wait_after_run`.
- 更新 `README.md` 说明 Remote-SSH 下如何用等待参数保持 gRPC server 在线.

## 2026-02-24T14:10:00Z

- 降低单图 `--stage fine` 的 OOM 概率: `SingleImagePipeline` 在 `stage != coarse` 时,初始化结束后主动释放 MoGe predictor 与 Flux inpainter,并执行 `gc.collect()` + `torch.cuda.empty_cache()`.
- 放宽 `SingleImageConfig.max_resolution` 为可配置整数,支持例如 `--max-resolution 384` 这类更省显存的设置(内部会向下对齐到 32 的倍数).

## 2026-02-24T14:25:00Z

- 进一步缓解 Flux inpainting 阶段 OOM: 将 MoGe predictor 改为延迟加载(只有真正需要深度预测时才创建),避免在 `FluxInpainting` 把主模型 `to(cuda)` 之前就占用大量显存导致“只差几十 MiB”失败.
- 增加 `--depth-device cpu` 兜底参数,允许把 MoGe 深度模型放到 CPU(更慢但更稳).
- 在 `FluxInpainting` 的 offload 切换(把 AE 放回 CPU 后)前额外 `torch.cuda.empty_cache()`,减少显存碎片与峰值抖动.

## 2026-02-24T15:19:52Z

- 改良单图 pipeline 的高斯文件(3DGS PLY)导出体验:
  - `SingleImageConfig` 新增 `export_gaussians` 与 `export_gaussians_ply_path`,通过 CLI 可控导出开关与导出路径.
  - `SingleImagePipeline.__call__` 在导出时打印明确的输出路径,避免用户找不到产物.
- 改良 `save_ply` 的压缩步骤:
  - 优先用 `shutil.which(\"splat-transform\")` 查找工具,缺失时跳过压缩但不影响原始 PLY 生成,并打印清晰提示.
- 更新 `README.md`:
  - 增加默认导出路径说明,以及如何覆盖/关闭导出.

## 2026-02-27T05:44:28Z

- 定位“高斯点云像准圆小圆点”的两类原因:
  - Rerun 的 3D 视图记录的是 `Points3D` 点云调试视图,不是 3DGS 的椭球 splat 渲染.
  - 现有导出 PLY 的 `scale_*` 与 `rot_*` 统计上接近各向同性/单位旋转,在 3DGS viewer 里也容易显得像圆点.
- 改良高斯初始化(根因修复):
  - `src/vistadream/ops/gs/basic.py` 的 `Gaussian_Frame._fine_init_scale_rotations` 改为基于深度反投影 `xyz` 的局部切平面估计:
    - 相邻像素 3D 差分估计切向量/法线.
    - 由(tangent_x,tangent_y,normal)构建旋转矩阵并转四元数.
    - 用局部像素间距估计 x/y 方向尺度,并让 z 方向更薄(更像表面椭球).
    - 数值退化/无效深度时自动回退到 coarse 初始化,保证稳健.
- 改良 Rerun 点云可视化:
  - `src/vistadream/api/single_img_pipeline.py` 的 `final_gaussian_scene` 记录 `radii=mean(exp(scale))`,减少“全是小圆点”的误解.
  - `src/vistadream/ops/gs/train.py` 修复 log 模式下把 log-scale 误当半径的问题,改为 `exp()` 后再记录.
- 文档与诊断工具:
  - `README.md`/`docs/single_img_pipeline.md` 增加 Troubleshooting: 为什么看起来像圆点,以及应如何正确判断 splat 效果.
  - 新增 `tools/analyze_gs_ply.py`,不依赖 `plyfile`,可快速统计 PLY 的 scale/rotation 各向异性.

## 2026-02-28T10:26:20Z

- 生成 OpenSpec change: `openspec/changes/integrate-fastgs-continuous-surface/`(schema: `spec-driven`),用于后续以规格驱动方式引入 "3DGS 连续表面训练" 能力.
- 工具链策略: 使用 pixi 环境的 `corepack` + `pnpm dlx` 运行 `openspec`,避免全局安装带来的环境污染.
- 已获取第一个 artifact(`proposal`)的 `instructions` 模板,并把 status/instructions 原文追加记录到 `notes.md`,便于下一步直接开始撰写 `proposal.md`.

## 2026-02-28T11:15:15Z

- 完成 OpenSpec `proposal` artifact:
  - 新增 `openspec/changes/integrate-fastgs-continuous-surface/proposal.md`,明确 "连续表面" 的目标是多视几何一致性与表面连贯性,并强调不引入薄片/厚度正则.
  - `openspec status` 验证: 进度变为 `1/4`,并解锁后续 artifacts: `design` 与 `specs`.

## 2026-02-28T11:25:05Z

- 完成 OpenSpec change 的剩余 artifacts(闭环 `4/4`):
  - 新增 `openspec/changes/integrate-fastgs-continuous-surface/design.md`,明确落地策略为“内嵌 FastGS-style + 几何监督”,并把 "连续表面 != 薄片" 写成硬约束.
  - 新增三份能力规格(每条需求均含 `#### Scenario` 的 WHEN/THEN,可直接映射为测试用例):
    - `openspec/changes/integrate-fastgs-continuous-surface/specs/fastgs-dataset-export/spec.md`
    - `openspec/changes/integrate-fastgs-continuous-surface/specs/fastgs-refine/spec.md`
    - `openspec/changes/integrate-fastgs-continuous-surface/specs/continuous-surface-supervision/spec.md`
  - 新增实现任务清单 `openspec/changes/integrate-fastgs-continuous-surface/tasks.md`,按依赖顺序拆分为可跟踪的 checkbox tasks.
  - `openspec status` 验证: progress `4/4`,显示 "All artifacts complete!".

## 2026-02-28T12:59:06Z

- 完整落地 OpenSpec change: `integrate-fastgs-continuous-surface`(30/30 tasks complete).

- fastgs-dataset-export:
  - 新增统一 exporter + 严格校验: `src/vistadream/ops/gs/fastgs_dataset.py`.
  - single-image pipeline opt-in 导出: `src/vistadream/api/single_img_pipeline.py`.
  - multi-image pipeline opt-in 导出: `src/vistadream/api/multi_image_pipeline.py`.
  - 新增/增强测试: `tests/test_fastgs_dataset_export.py`.

- continuous-surface-supervision:
  - 新增可单测的几何监督实现: `src/vistadream/ops/gs/continuous_surface_supervision.py`.
  - 新增单测: `tests/test_continuous_surface_supervision.py`.
  - 明确硬约束: 不引入 thinness/thickness/薄片正则,配置出现则报错.

- fastgs-refine:
  - 新增 refine runner: `src/vistadream/ops/gs/refine.py`.
  - 新增 PLY 加载: `src/vistadream/ops/gs/basic.py` -> `load_ply_as_gaussian_scene`.
  - 新增独立 CLI: `tools/run_fastgs_refine.py`.
  - multi-image pipeline 支持可选 refine 触发(需用户提供 init gaussians PLY).
  - refine 输出 `gaussians_refined.ply` + `refine_meta.json`,并记录深度/法线一致性指标与 per-view 对齐参数.

- 文档:
  - 更新 `README.md` 与 `docs/single_img_pipeline.md`,补齐 refine dataset 导出与 refine 运行示例,并强调“连续表面 != 薄片”.

- 验证:
  - `pixi run -e dev pytest -q` -> 9 passed.
  - `pixi run -e dev ruff check <改动文件>` -> All checks passed.

## 2026-02-28T13:58:50Z

- 补充测试: 新增 `tests/test_fastgs_refine_smoke.py`,在 CUDA 可用时端到端跑一次最小 refine,确保 refine runner 真实可跑.
- 验证: `pixi run -e dev pytest -q` -> 10 passed.

## 2026-03-01T06:25:36Z

- 改良 `--stage coarse` 的可观测性与可调性:
  - `src/vistadream/api/single_img_pipeline.py`:
    - coarse 结束后打印结构化 Summary,明确是否选到新帧,以及每帧 inpaint 比例与新增 splats 数量.
    - coarse 选帧逻辑抽为纯函数 `_select_best_pose_index`,便于单测与调参.
    - `SingleImageConfig` 新增 coarse 选帧参数与轨迹幅度参数(保持默认值不变).
  - `src/vistadream/ops/gs/basic.py`: `Gaussian_Scene._add_trainable_frame(...)` 返回 `Gaussian_Frame`,便于统计新增 splats.

- 新增单测:
  - `tests/test_coarse_frame_selection.py`: 覆盖 max/min ratio 与相邻帧剔除逻辑.

- 验证:
  - `pixi run -e dev pytest -q` -> 5 passed.
  - `pixi run -e dev ruff check <改动文件>` -> All checks passed.

## 2026-03-01T06:16:55Z

- 技术评估: 调研 `/workspace/FreeTimeGsVanilla` 的数据预处理链路,确认其做法是 "参考帧跑一次 COLMAP 标定静态相机 + RoMa(romatch) 逐帧密集匹配并在已知位姿下三角化点云",而不是 "让 COLMAP 用 RoMa 做 SfM".
- 对 Vistadream 的结论: 当前 `colmap` 相关代码仅用于导出 COLMAP txt 兼容格式,主流程(单图/多图)的位姿与深度来自 learned 模型,因此引入 RoMa 并非刚需. 借鉴价值主要在工程套路(外点过滤,anchor-only pair graph,voxel 去重控制规模),以及未来若要支持多相机动态序列可复用该思路.

## 2026-03-01T07:28:24Z

- 改良 `--stage coarse` 选帧失败的可观测性:
  - `src/vistadream/api/single_img_pipeline.py`: 当 `_next_frame()` 选不到新帧时,打印 `[COARSE][DIAG]` 统计(分布/过滤原因/top-k),用来判断该调阈值还是调 motion.

- 增加 coarse 更激进的显式兜底选帧:
  - `SingleImageConfig` 新增 `coarse_fallback_mode={none,closest}`(默认 none).
  - `_select_best_pose_index(...)` 支持 fallback: 严格模式无解时,选择“最接近 [min,max] 区间”的候选帧继续推进.
  - coarse Summary 额外打印 `fallback_mode`,并在 fallback 生效时对选中帧打印标记.

- 新增/增强测试:
  - `tests/test_coarse_frame_selection.py`: 覆盖 `fallback_mode=closest` 在“全都 > max / 全都 < min / 相邻剔除全覆盖”三种情况的行为.

- 验证:
  - `pixi run -e dev pytest -q` -> 8 passed.
  - `pixi run -e dev ruff check src/vistadream/api/single_img_pipeline.py tests/test_coarse_frame_selection.py` -> All checks passed.
